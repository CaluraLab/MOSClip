---
title: "Multiomics vignette"
output: 
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# Installation

First of all we need to install NewWave:

```{r, eval = FALSE}
if(!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
BiocManager::install("NewWave")
```


```{r}
suppressPackageStartupMessages(
  {library(org.Hs.eg.db)
library(pheatmap)
library(RColorBrewer)
library(graphite)
library(EDASeq)
library(houseOfClipUtility)
library(biocmosclip)
library(MultiAssayExperiment)}
)
```

```{r}
load("../inst/TCGA-OV-hg38-preprocessed-externalSurv.RData")
```


```{r}
survAnnotations <- fup$pfs

expression <- rnaSeq
row.names(expression) <- paste0("ENTREZID:", row.names(expression))
mutation <- mutations$data
row.names(mutation) <- paste0("ENTREZID:", row.names(mutation))
names(metClustValues$eMap) <- paste0("ENTREZID:", row.names(metClustValues$eMap))
row.names(cnv) <- paste0("ENTREZID:", row.names(cnv))

survAnnot <- na.omit(survAnnotations)
patients <- row.names(survAnnot)
patients <- intersect(patients, colnames(expression))
patients <- intersect(patients, colnames(metClustValues$MET_Cancer_Clustered))
patients <- intersect(patients, colnames(mutation))
patients <- intersect(patients, colnames(cnv))
```


```{r}
survAnnot <- survAnnot[patients, , drop = F]
dirname = "vignettes"

expression <- expression[, patients, drop = F]
keep = apply(expression >= 100, 1, any)
expNorm <- betweenLaneNormalization(expression[keep, , drop = F], which = "upper")
pseudoExpNorm <- log2(expNorm + 1)

methylation <- metClustValues
methylation$MET_Cancer_Clustered <- methylation$MET_Cancer_Clustered[, patients, 
                                                                     drop = F]

mutation <- mutation[, patients, drop = F]
cnv <- cnv[, patients, drop = F]
```


```{r}
reactome <- pathways("hsapiens", "reactome")
names <- c("PI3K Cascade","Apoptotic cleavage of cellular proteins","RAF-independent MAPK1/3 activation" ,"Mitochondrial protein import")
reactome <- reactome[names]

reactome <- convertIdentifiers(reactome, "entrez")

nodesLength <- sapply(reactome, function(g) {
  length(intersect(graphite::nodes(g), row.names(pseudoExpNorm)))
})


reactUsed <-  reactome

```


```{r}

```


```{r}
pathHierarchy <- houseOfClipUtility::downloadPathwayRelationFromReactome()
pathHierarchyGraph <- igraph::graph.data.frame(d = pathHierarchy, directed = TRUE)
```


```{r}
multiOmics <- Omics(experiments = ExperimentList(expr = pseudoExpNorm, met = methylation$MET_Cancer_Clustered, 
                                                 mut = mutation, cnv = cnv),
                    colData = survAnnot,
                    modelInfo = c("summarizeWithPca", "summarizeInCluster", 
                                  "summarizeToNumberOfEvents", "summarizeToNumberOfDirectionalEvents"),
                    specificArgs = list(pcaArgs = list(name = "exp",
                                                       shrink = "FALSE", method = "sparse", maxPCs = 3),
                                        clusterArgs = list(name = "met",  dict = methylation$eMap, max_cluster_number = 3),
                                        countEvent = list(name = "mut", min_prop = 0.05), cnvAgv = list(name = "cnv", min_prop = 0.05)))

genesToConsider <- row.names(pseudoExpNorm)
```


```{r}
multiOmicsReactome <- lapply(reactUsed, function(g) {
    print(g@title)  # uncomment this to see the progression along pathways
    set.seed(1234)
    fcl = multiOmicsSurvivalModuleTest(multiOmics, g, useThisGenes = genesToConsider)
    fcl
})

moduleSummary <- multiPathwayModuleReport(multiOmicsReactome)
moduleSummary


useThisPathways <- unique(moduleSummary$pathway[moduleSummary$pvalue <= 0.05])
sModule <- moduleSummary[moduleSummary$pathway %in% useThisPathways, , drop = T]
```



# pathways



```{r}
multiOmics@specificArgs$pcaArgs$method = "topological"
multiOmics@specificArgs$pcaArgs$shrink = TRUE
genesToConsider <- row.names(pseudoExpNorm)


  
 multiOmicsFullHuge <- lapply(reactUsed, function(g){
    print(g@title)
    set.seed(1234)
    fcl = multiOmicsSurvivalPathwayTest(multiOmics, g, useThisGenes = genesToConsider)
    fcl
})
```

